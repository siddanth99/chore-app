// web/app/chores/page.tsx
import { ChoreType } from '@prisma/client'
import { getCurrentUser } from '@/server/auth/role'
import {
  listPublishedChoresWithFilters,
  getChoresWithinDistance,
  getUniqueCategories,
} from '@/server/api/chores'
import { BrowseChoresClient } from '@/components/chores/BrowseChoresClient'
import { Filters } from '@/components/chores/types'

type RawSearchParams = {
  type?: string
  location?: string
  category?: string
  workerLat?: string
  workerLng?: string
  distanceKm?: string
  q?: string // Search query for browse-v2
  categories?: string | string[] // Multiple categories for browse-v2
  minBudget?: string
  maxBudget?: string
  status?: string | string[]
}

export default async function ChoresPage({
  searchParams,
}: {
  searchParams: Promise<RawSearchParams>
}) {
  // Next 15/16: searchParams is a Promise
  const resolved = await searchParams

  // Build server-side filters (for Prisma query)
  const serverFilters: { type?: ChoreType; location?: string; category?: string } = {}

  if (resolved.type === 'ONLINE' || resolved.type === 'OFFLINE') {
    serverFilters.type = resolved.type as ChoreType
  }

  if (resolved.location) {
    serverFilters.location = resolved.location
  }

  if (resolved.category) {
    serverFilters.category = resolved.category
  }

  const user = await getCurrentUser()
  const excludeUserId = user?.role === 'WORKER' ? user.id : undefined

  // Parse distance params
  const workerLat = resolved.workerLat ? parseFloat(resolved.workerLat) : NaN
  const workerLng = resolved.workerLng ? parseFloat(resolved.workerLng) : NaN
  const distanceKm = resolved.distanceKm ? parseFloat(resolved.distanceKm) : NaN

  const isDistanceFilterActive =
    user?.role === 'WORKER' &&
    !Number.isNaN(workerLat) &&
    !Number.isNaN(workerLng) &&
    !Number.isNaN(distanceKm) &&
    workerLat >= -90 &&
    workerLat <= 90 &&
    workerLng >= -180 &&
    workerLng <= 180 &&
    distanceKm >= 0

  // Fetch chores and categories in parallel
  const [chores, categories] = await Promise.all([
    isDistanceFilterActive
      ? getChoresWithinDistance(workerLat, workerLng, distanceKm, excludeUserId)
      : listPublishedChoresWithFilters(serverFilters, excludeUserId),
    getUniqueCategories(),
  ])

  // Transform URL params to browse-v2 Filters format
  const browseV2Filters: Filters = {
    q: resolved.q || undefined,
    categories: Array.isArray(resolved.categories)
      ? resolved.categories
      : resolved.categories
      ? [resolved.categories]
      : resolved.category
      ? [resolved.category]
      : undefined,
    type:
      resolved.type === 'ONLINE'
        ? 'online'
        : resolved.type === 'OFFLINE'
        ? 'offline'
        : 'all',
    minBudget: resolved.minBudget ? parseFloat(resolved.minBudget) : undefined,
    maxBudget: resolved.maxBudget ? parseFloat(resolved.maxBudget) : undefined,
    status: Array.isArray(resolved.status)
      ? resolved.status
      : resolved.status
      ? [resolved.status]
      : undefined,
    nearMe: isDistanceFilterActive,
  }

  return (
    <BrowseChoresClient
      initialChores={chores}
      initialFilters={browseV2Filters}
    />
  )
}
